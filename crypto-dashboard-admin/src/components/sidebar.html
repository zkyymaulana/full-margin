<!-- Crypto Dashboard Sidebar -->
<div class="flex flex-col h-[calc(100vh-128px)] justify-between">
  <!-- Top Section -->
  <div>
    <!-- Logo Section -->
    <div class="p-4">
      <div class="flex items-center gap-3 mb-6">
        <div
          class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center"
        >
          <span class="text-white font-bold text-sm">‚Çø</span>
        </div>
        <div>
          <h3 class="font-semibold text-gray-800">Crypto Admin</h3>
          <p class="text-xs text-gray-500">Dashboard v1.0</p>
        </div>
      </div>
    </div>

    <!-- Sidebar Navigation -->
    <div class="scroll-sidebar px-4" data-simplebar>
      <nav class="flex flex-col sidebar-nav">
        <ul id="sidebarnav" class="text-gray-600 text-sm">
          <!-- Dashboard Section -->
          <li class="text-xs font-bold pb-[5px]">
            <span class="text-xs text-gray-400 font-semibold">DASHBOARD</span>
          </li>

          <li class="sidebar-item">
            <a
              class="sidebar-link gap-3 py-2.5 my-1 text-base flex items-center relative rounded-md text-blue-600 bg-blue-50 w-full"
              href="#"
              data-page="dashboard"
            >
              <span class="text-2xl">üìä</span>
              <span>Market Overview</span>
            </a>
          </li>

          <!-- Crypto Analysis Section -->
          <li class="text-xs font-bold mb-4 mt-6">
            <span class="text-xs text-gray-400 font-semibold"
              >CRYPTO ANALYSIS</span
            >
          </li>

          <li class="sidebar-item">
            <a
              class="sidebar-link gap-3 py-2.5 my-1 text-base flex items-center relative rounded-md text-gray-500 hover:text-blue-600 hover:bg-blue-50 w-full"
              href="#"
              data-page="indicators"
            >
              <span class="text-2xl">üßÆ</span>
              <span>Technical Indicators</span>
            </a>
          </li>

          <li class="sidebar-item">
            <a
              class="sidebar-link gap-3 py-2.5 my-1 text-base flex items-center relative rounded-md text-gray-500 hover:text-blue-600 hover:bg-blue-50 w-full"
              href="#"
              data-page="signals"
            >
              <span class="text-2xl">‚ö°</span>
              <span>Live Signals</span>
            </a>
          </li>

          <li class="sidebar-item">
            <a
              class="sidebar-link gap-3 py-2.5 my-1 text-base flex items-center relative rounded-md text-gray-500 hover:text-blue-600 hover:bg-blue-50 w-full"
              href="#"
              data-page="marketcap"
            >
              <span class="text-2xl">ü™ô</span>
              <span>Market Cap Analysis</span>
            </a>
          </li>

          <!-- Tools & Settings Section -->
          <li class="text-xs font-bold mb-4 mt-6">
            <span class="text-xs text-gray-400 font-semibold">SETTINGS</span>
          </li>

          <li class="sidebar-item">
            <a
              class="sidebar-link gap-3 py-2.5 my-1 text-base flex items-center relative rounded-md text-gray-500 hover:text-blue-600 hover:bg-blue-50 w-full"
              href="#"
              data-page="settings"
            >
              <span class="text-2xl">‚öôÔ∏è</span>
              <span>System Settings</span>
            </a>
          </li>

          <!-- User Account Section -->
          <li class="text-xs font-bold mb-4 mt-6">
            <span class="text-xs text-gray-400 font-semibold">ACCOUNT</span>
          </li>

          <li class="sidebar-item">
            <div class="px-3 py-2 bg-gray-50 rounded-lg mb-2">
              <div class="flex items-center gap-3">
                <div
                  class="w-8 h-8 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center"
                >
                  <span class="text-white text-xs font-bold" id="user-avatar"
                    >A</span
                  >
                </div>
                <div class="flex-1 min-w-0">
                  <div
                    class="text-sm font-medium text-gray-900 truncate sidebar-user-name"
                  >
                    Admin User
                  </div>
                  <div
                    class="text-xs text-gray-500 truncate sidebar-user-email"
                  >
                    admin@crypto.com
                  </div>
                </div>
              </div>
            </div>
          </li>

          <li class="sidebar-item">
            <button
              class="sidebar-link gap-3 py-2.5 my-1 text-base flex items-center relative rounded-md text-gray-500 hover:text-red-600 hover:bg-red-50 w-full"
              id="logout-btn"
              onclick="window.handleLogoutClick(event)"
            >
              <span class="text-2xl">üö™</span>
              <span>Logout</span>
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Bottom Section -->
  <div class="m-4">
    <div
      class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg text-center mb-4"
    >
      <div class="text-2xl mb-2">üöÄ</div>
      <h4 class="font-semibold text-sm mb-1">Crypto Dashboard Pro</h4>
      <p class="text-xs opacity-90 mb-3">Real-time market analysis</p>
      <div class="text-xs opacity-75">
        <div>Last Updated: <span id="sidebar-last-update">--:--:--</span></div>
        <div class="mt-1">
          Status:
          <span class="text-green-300" id="sidebar-connection-status"
            >Connected</span
          >
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  // ============================================
  // BAGIAN 1: FUNGSI GLOBAL (HARUS DI ATAS)
  // ============================================

  console.log("üöÄ SIDEBAR SCRIPT LOADED!");

  // Test function untuk memastikan onclick bekerja
  window.testLogout = function () {
    console.log("üß™ TEST LOGOUT CLICKED!");
    alert("Test button works! Now checking main logout...");
    window.handleLogoutClick(new Event("click"));
  };

  // Handler untuk onclick di button
  window.handleLogoutClick = function (event) {
    console.log("üö™ handleLogoutClick DIPANGGIL!", event);
    event.preventDefault();
    event.stopPropagation();

    console.log("üì± Memanggil showLogoutModal...");
    window.showLogoutModal();
  };

  // Fungsi untuk menampilkan modal logout
  window.showLogoutModal = function () {
    console.log("üì± === SHOW LOGOUT MODAL CALLED ===");

    // Hapus modal yang sudah ada
    const existing = document.getElementById("logout-modal");
    if (existing) {
      console.log("üóëÔ∏è Menghapus modal lama");
      existing.remove();
    }

    // Buat modal baru
    const modal = document.createElement("div");
    modal.id = "logout-modal";
    modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    opacity: 0;
    transition: opacity 0.3s;
  `;

    modal.innerHTML = `
    <div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="width: 48px; height: 48px; background: #fee; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 16px;">
          <span style="font-size: 24px;">üö™</span>
        </div>
        <h3 style="font-size: 18px; font-weight: 600; color: #111; margin-bottom: 8px;">Confirm Logout</h3>
        <p style="color: #666; font-size: 14px;">Are you sure you want to logout?</p>
      </div>
      
      <div style="display: flex; gap: 12px;">
        <button 
          id="cancel-logout"
          style="flex: 1; padding: 10px; background: #f3f4f6; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; color: #374151;"
          onmouseover="this.style.background='#e5e7eb'"
          onmouseout="this.style.background='#f3f4f6'"
        >
          Cancel
        </button>
        <button 
          id="confirm-logout"
          style="flex: 1; padding: 10px; background: #dc2626; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;"
          onmouseover="this.style.background='#b91c1c'"
          onmouseout="this.style.background='#dc2626'"
        >
          Yes, Logout
        </button>
      </div>
    </div>
  `;

    document.body.appendChild(modal);
    console.log("‚úÖ Modal ditambahkan ke body");

    // Animate in
    setTimeout(() => {
      modal.style.opacity = "1";
      console.log("‚úÖ Modal fade in");
    }, 10);

    // Event listeners
    document.getElementById("cancel-logout").onclick = function (e) {
      console.log("‚ùå Cancel diklik");
      e.preventDefault();
      modal.style.opacity = "0";
      setTimeout(() => modal.remove(), 300);
    };

    document.getElementById("confirm-logout").onclick = async function (e) {
      console.log("‚úÖ Confirm diklik");
      e.preventDefault();
      this.textContent = "Logging out...";
      this.disabled = true;

      await window.handleLogout();
    };

    // Close on backdrop
    modal.onclick = function (e) {
      if (e.target === modal) {
        console.log("üñ±Ô∏è Backdrop diklik");
        modal.style.opacity = "0";
        setTimeout(() => modal.remove(), 300);
      }
    };
  };

  // Fungsi untuk handle logout
  window.handleLogout = async function () {
    console.log("üîí === HANDLE LOGOUT ===");

    try {
      const token = localStorage.getItem("authToken");

      if (token) {
        console.log("üì° Calling logout API...");

        try {
          const response = await fetch(
            "http://localhost:8000/api/auth/logout",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          console.log("üì° API Response:", response.status);
        } catch (err) {
          console.warn("‚ö†Ô∏è API error (continuing):", err);
        }
      }

      // Clear storage
      console.log("üßπ Clearing storage...");
      localStorage.clear();
      sessionStorage.clear();

      // Show notification
      const notif = document.createElement("div");
      notif.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      z-index: 100000;
      font-weight: 500;
    `;
      notif.textContent = "‚úÖ Logout successful! Redirecting...";
      document.body.appendChild(notif);

      // Redirect
      setTimeout(() => {
        console.log("üöÄ Redirecting to login...");
        window.location.href = "/src/pages/login.html";
      }, 1000);
    } catch (error) {
      console.error("‚ùå Logout error:", error);
      alert("Logout failed: " + error.message);
    }
  };

  // ============================================
  // BAGIAN 2: DOM READY - INISIALISASI
  // ============================================

  document.addEventListener("DOMContentLoaded", function () {
    console.log("üîß === DOM CONTENT LOADED ===");

    // Update user info
    updateUserInfoFromStorage();

    // Setup navigation
    setupNavigation();

    // Setup quick actions
    setupQuickActions();

    // Update sidebar status
    updateSidebarStatus();
    setInterval(updateSidebarStatus, 30000);

    // Handle online/offline
    window.addEventListener("online", updateSidebarStatus);
    window.addEventListener("offline", updateSidebarStatus);

    // TEST: Cek apakah logout button ada
    setTimeout(() => {
      const btn = document.getElementById("logout-btn");
      console.log("üîç Checking logout button existence:", btn);
      console.log("üîç Button onclick:", btn ? btn.onclick : "BUTTON NOT FOUND");
      console.log("üîç Button parent:", btn ? btn.parentElement : "N/A");
    }, 1000);
  });

  function updateUserInfoFromStorage() {
    const userName = localStorage.getItem("userName");
    const userEmail = localStorage.getItem("userEmail");

    if (userName && userEmail) {
      const userNameEl = document.querySelector(".sidebar-user-name");
      const userEmailEl = document.querySelector(".sidebar-user-email");
      const userAvatar = document.getElementById("user-avatar");

      if (userNameEl) userNameEl.textContent = userName;
      if (userEmailEl) userEmailEl.textContent = userEmail;
      if (userAvatar) userAvatar.textContent = userName.charAt(0).toUpperCase();
    }
  }

  function setupNavigation() {
    const sidebarLinks = document.querySelectorAll("[data-page]");
    console.log(`üîç Found ${sidebarLinks.length} navigation links`);

    sidebarLinks.forEach((link) => {
      const pageName = link.getAttribute("data-page");

      link.addEventListener("click", function (e) {
        e.preventDefault();
        console.log(`üöÄ Navigation clicked: ${pageName}`);

        // Update active state
        sidebarLinks.forEach((l) => {
          l.classList.remove("text-blue-600", "bg-blue-50");
          l.classList.add("text-gray-500");
        });

        this.classList.remove("text-gray-500");
        this.classList.add("text-blue-600", "bg-blue-50");

        // Navigate
        if (window.navigateToPage) {
          window.navigateToPage(pageName);
        } else if (window.loadComponent) {
          window.loadComponent("content", `/src/pages/${pageName}.html`);
        } else {
          loadPageDirectly(pageName);
        }
      });
    });
  }

  function loadPageDirectly(pageName) {
    const contentElement = document.getElementById("content");
    if (!contentElement) return;

    fetch(`/src/pages/${pageName}.html`)
      .then((response) => response.text())
      .then((html) => {
        contentElement.innerHTML = html;
        if (window.initializePageFunctionality) {
          window.initializePageFunctionality(pageName);
        }
      })
      .catch((error) => {
        console.error(`‚ùå Error loading ${pageName}:`, error);
        contentElement.innerHTML = `
        <div style="padding: 32px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 16px;">üòï</div>
          <h2 style="font-size: 24px; font-weight: bold; color: #374151; margin-bottom: 8px;">Page Not Found</h2>
          <p style="color: #6b7280; margin-bottom: 16px;">Sorry, we couldn't load the ${pageName} page.</p>
          <button onclick="location.reload()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
            Refresh Page
          </button>
        </div>
      `;
      });
  }

  function setupQuickActions() {
    console.log("üîß Setting up quick actions...");

    // Refresh all data
    const refreshBtn = document.getElementById("refresh-all-data");
    if (refreshBtn) {
      refreshBtn.addEventListener("click", function () {
        console.log("üîÑ Refresh clicked");
        const icon = this.querySelector("span");
        icon.style.transform = "rotate(360deg)";
        icon.style.transition = "transform 1s";

        if (window.dataPoller && window.dataPoller.fetchData) {
          window.dataPoller.fetchData();
        }

        setTimeout(() => {
          icon.style.transform = "rotate(0deg)";
        }, 1000);
      });
    }

    // Clear cache
    const clearBtn = document.getElementById("clear-cache-btn");
    if (clearBtn) {
      clearBtn.addEventListener("click", function () {
        console.log("üóëÔ∏è Clear cache clicked");
        if (window.cache) window.cache.clear();
        localStorage.removeItem("chartCache");
        sessionStorage.clear();
      });
    }

    // Logout button sudah ada onclick di HTML
    const logoutBtn = document.getElementById("logout-btn");
    console.log("üîç Logout button found:", logoutBtn);
    console.log(
      "üîç Logout button onclick:",
      logoutBtn ? logoutBtn.getAttribute("onclick") : "NULL"
    );
  }

  function updateSidebarStatus() {
    const lastUpdate = document.getElementById("sidebar-last-update");
    const status = document.getElementById("sidebar-connection-status");

    if (lastUpdate) {
      const now = new Date();
      lastUpdate.textContent = now.toLocaleTimeString();
    }

    if (status) {
      status.textContent = navigator.onLine ? "Connected" : "Offline";
      status.className = navigator.onLine ? "text-green-300" : "text-red-300";
    }
  }

  window.updateSidebarUserInfo = updateUserInfoFromStorage;

  console.log("‚úÖ Sidebar script initialized!");
</script>
