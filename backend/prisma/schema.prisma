generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Timeframe {
  id        Int      @id @default(autoincrement())
  timeframe String   @unique

  candles        Candle[]
  indicators     Indicator[]
  indicatorWeights IndicatorWeight[]
}

model Coin {
  id        Int      @id @default(autoincrement())
  symbol    String   @unique
  name      String?
  rank      Int?
  logo      String?
  createdAt DateTime @default(now())

  candles          Candle[]
  indicators       Indicator[]
  indicatorWeights IndicatorWeight[]
  topCoins         TopCoin[]
}

model Candle {
  id          Int      @id @default(autoincrement())
  coinId      Int
  timeframeId Int
  time        BigInt
  open        Float
  high        Float
  low         Float
  close       Float
  volume      Float

  coin       Coin      @relation(fields: [coinId], references: [id], onDelete: Cascade)
  timeframe  Timeframe @relation(fields: [timeframeId], references: [id])

  @@unique([coinId, timeframeId, time])
  @@index([coinId, time])
}

model Indicator {
  id          Int      @id @default(autoincrement())
  coinId      Int
  timeframeId Int
  time        BigInt

  // Raw indicator values
  sma20          Float?
  sma50          Float?
  ema20          Float?
  ema50          Float?
  rsi            Float?
  macd           Float?
  macdSignalLine Float?
  macdHist       Float?
  bbUpper        Float?
  bbMiddle       Float?
  bbLower        Float?
  stochK         Float?
  stochD         Float?
  stochRsiK      Float?
  stochRsiD      Float?
  psar           Float?

  // Individual signals
  smaSignal      String?
  emaSignal      String?
  rsiSignal      String?
  macdSignal     String?
  bbSignal       String?
  stochSignal    String?
  stochRsiSignal String?
  psarSignal     String?

  // Aggregated signal
  overallSignal  String?
  signalStrength Float?
  finalScore     Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  coin      Coin      @relation(fields: [coinId], references: [id], onDelete: Cascade)
  timeframe Timeframe @relation(fields: [timeframeId], references: [id])

  @@unique([coinId, timeframeId, time])
  @@index([coinId, time])
  @@index([overallSignal])
}

model IndicatorWeight {
  id           Int      @id @default(autoincrement())
  coinId       Int
  timeframeId  Int

  startTrain   BigInt
  endTrain     BigInt

  weights      Json
  roi          Float
  winRate      Float
  maxDrawdown  Float
  sharpeRatio  Float 
  trades       Int
  finalCapital Float
  candleCount  Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  coin      Coin      @relation(fields: [coinId], references: [id], onDelete: Cascade)
  timeframe Timeframe @relation(fields: [timeframeId], references: [id])

  @@unique([coinId, timeframeId, startTrain, endTrain])
  @@index([coinId, timeframeId]) 
}


model TopCoin {
  id        Int      @id @default(autoincrement())
  coinId    Int
  price     Float
  marketCap Float
  volume24h Float
  createdAt DateTime @default(now())

  coin Coin @relation(fields: [coinId], references: [id], onDelete: Cascade)
}

model User {
  id              Int      @id @default(autoincrement())
  email           String   @unique
  name            String?
  passwordHash    String
  createdAt       DateTime @default(now())
  lastLogin       DateTime?
  avatarUrl       String?
  telegramChatId  String?
  telegramEnabled Boolean  @default(false)

  authLogs AuthLog[]
}

model AuthLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  action    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
